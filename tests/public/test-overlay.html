<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test: Overlay Mode</title>
    <style>
        body { font-family: sans-serif; padding: 2rem; }
        .content { max-width: 600px; margin: 0 auto; }
        .dummy-block { height: 200px; background: #f0f0f0; margin: 1rem 0; border-radius: 8px; }
    </style>
</head>
<body>
    <div class="content">
        <h1>üç∑ Winery Landing Page</h1>
        <p>This content exists in the DOM but should be covered by the gate initially.</p>
        <div class="dummy-block"></div>
        <p>You should not be able to scroll past the overlay.</p>
        <div class="dummy-block"></div>
        <button onclick="AgeWallet.logout()">Reset / Logout</button>
    </div>

    <script type="module">
        import AgeWallet from '../../src/index.js'; // Importing direct source for dev testing

        const aw = new AgeWallet({
            clientId: 'test-client-id',
            mode: 'overlay',
            // Point to our local Mock Functions
            redirectUri: window.location.href.split('?')[0]
        });

        // Monkey-patch the Auth URL generator to use our Mock Server instead of real AgeWallet
        aw.generateAuthUrl = async function() {
            const state = this.security.generateRandomString(16);
            const nonce = this.security.generateRandomString(16);
            const verifier = this.security.generatePkceVerifier();
            this.storage.setOidcState(state, verifier, nonce, this.config.redirectUri);

            return {
                url: `/.netlify/functions/mock-oidc?response_type=code&state=${state}&redirect_uri=${this.config.redirectUri}`,
                state: state
            };
        };

        // Monkey-patch Token Exchange to use Mock Server
        const originalHandleCallback = aw.handleCallback.bind(aw);
        aw.handleCallback = async function(code, state) {
            // We override the endpoint to hit our local mock function
            const stored = this.storage.getOidcState();
            if (!stored || stored.state !== state) return;

            const tokenData = await this.network.postForm('/.netlify/functions/mock-oidc', {
                grant_type: 'authorization_code',
                code: code
            });

            this.storage.setVerification(tokenData);
        };

        aw.init();

        // Expose to window for the Logout button
        window.AgeWallet = aw;
    </script>
</body>
</html>